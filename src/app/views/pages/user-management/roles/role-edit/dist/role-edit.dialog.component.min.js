"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var o,s=arguments.length,n=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var l=e.length-1;0<=l;l--)(o=e[l])&&(n=(s<3?o(n):3<s?o(t,i,n):o(t,i))||n);return 3<s&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(i,r){return function(e,t){r(e,t,i)}};exports.__esModule=!0;var core_1=require("@angular/core"),dialog_1=require("@angular/material/dialog"),rxjs_1=require("rxjs"),lodash_1=require("lodash"),store_1=require("@ngrx/store"),auth_1=require("../../../../../core/auth"),operators_1=require("rxjs/operators"),RoleEditDialogComponent=function(){function e(e,t,i){this.dialogRef=e,this.data=t,this.store=i,this.hasFormErrors=!1,this.viewLoading=!1,this.loadingAfterSubmit=!1,this.rolePermissions=[]}return e.prototype.ngOnInit=function(){var t=this;if(this.data.roleId)this.role$=this.store.pipe(store_1.select(auth_1.selectRoleById(this.data.roleId)));else{var e=new auth_1.Role;e.clear(),this.role$=rxjs_1.of(e)}this.role$.subscribe(function(e){e&&(t.role=new auth_1.Role,t.role.id=e.id,t.role.title=e.title,t.role.permissions=e.permissions,t.role.isCoreRole=e.isCoreRole,t.allPermissions$=t.store.pipe(store_1.select(auth_1.selectAllPermissions)),t.loadPermissions())})},e.prototype.ngOnDestroy=function(){this.componentSubscriptions&&this.componentSubscriptions.unsubscribe()},e.prototype.loadPermissions=function(){var o=this;this.allPermissions$.subscribe(function(i){i&&i.filter(function(e){return!e.parentId}).forEach(function(t){var e=o.role.permissions.some(function(e){return e===t.id}),r=new auth_1.Permission;r.clear(),r.isSelected=e,r._children=[],r.id=t.id,r.level=t.level,r.parentId=t.parentId,r.title=t.title,i.filter(function(e){return e.parentId&&e.parentId===t.id}).forEach(function(t){var e=o.role.permissions.some(function(e){return e===t.id}),i=new auth_1.Permission;i.clear(),i.isSelected=e,i._children=[],i.id=t.id,i.level=t.level,i.parentId=t.parentId,i.title=t.title,r._children.push(i)}),o.rolePermissions.push(r)})})},e.prototype.preparePermissionIds=function(){var t=[];return lodash_1.each(this.rolePermissions,function(e){e.isSelected&&(t.push(e.id),lodash_1.each(e._children,function(e){e.isSelected&&t.push(e.id)}))}),t},e.prototype.prepareRole=function(){var e=new auth_1.Role;return e.id=this.role.id,e.permissions=this.preparePermissionIds(),e.title=this.role.title,e.isCoreRole=this.role.isCoreRole,e},e.prototype.onSubmit=function(){if(this.hasFormErrors=!1,this.loadingAfterSubmit=!1,this.isTitleValid()){var e=this.prepareRole();e.id?this.updateRole(e):this.createRole(e)}else this.hasFormErrors=!0},e.prototype.updateRole=function(e){var t=this;this.loadingAfterSubmit=!0,this.viewLoading=!0;var i={id:this.role.id,changes:e};this.store.dispatch(new auth_1.RoleUpdated({partialrole:i,role:e})),rxjs_1.of(void 0).subscribe(function(){t.viewLoading=!1,t.dialogRef.close({_role:e,isEdit:!0})})},e.prototype.createRole=function(t){var i=this;this.loadingAfterSubmit=!0,this.viewLoading=!0,this.store.dispatch(new auth_1.RoleOnServerCreated({role:t})),this.componentSubscriptions=this.store.pipe(operators_1.delay(1e3),store_1.select(auth_1.selectLastCreatedRoleId)).subscribe(function(e){e&&(i.viewLoading=!1,i.dialogRef.close({_role:t,isEdit:!1}))})},e.prototype.onAlertClose=function(e){this.hasFormErrors=!1},e.prototype.isSelectedChanged=function(e,t){var i;0===t._children.length&&t.isSelected?(i=lodash_1.find(this.rolePermissions,function(e){return e.id===t.parentId}))&&!i.isSelected&&(i.isSelected=!0):0!==t._children.length||t.isSelected?0<t._children.length&&t.isSelected?lodash_1.each(t._children,function(e){return e.isSelected=!0}):0<t._children.length&&!t.isSelected&&lodash_1.each(t._children,function(e){e.isSelected=!1}):(i=lodash_1.find(this.rolePermissions,function(e){return e.id===t.parentId}))&&i.isSelected&&(lodash_1.some(i._children,function(e){return!0===e.isSelected})||(i.isSelected=!1))},e.prototype.getTitle=function(){return this.role&&this.role.id?"Edit role '"+this.role.title+"'":"New role"},e.prototype.isTitleValid=function(){return this.role&&this.role.title&&0<this.role.title.length},e=__decorate([core_1.Component({selector:"app-role-edit-dialog",templateUrl:"./role-edit.dialog.component.html",changeDetection:core_1.ChangeDetectionStrategy.Default}),__param(1,core_1.Inject(dialog_1.MAT_DIALOG_DATA))],e)}();exports.RoleEditDialogComponent=RoleEditDialogComponent;
//# sourceMappingURL=role-edit.dialog.component.min.js.map
