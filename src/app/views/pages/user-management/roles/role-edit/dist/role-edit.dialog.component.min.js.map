{"version":3,"sources":["role-edit.dialog.component.ts"],"names":["core_1","require","dialog_1","rxjs_1","lodash_1","store_1","auth_1","operators_1","RoleEditDialogComponent","dialogRef","data","store","this","hasFormErrors","viewLoading","loadingAfterSubmit","rolePermissions","prototype","ngOnInit","_this","roleId","role$","pipe","select","selectRoleById","newRole","Role","clear","of","subscribe","res","role","id","title","permissions","isCoreRole","allPermissions$","selectAllPermissions","loadPermissions","ngOnDestroy","componentSubscriptions","unsubscribe","_allPermissions","filter","el","parentId","forEach","element","hasUserPermission","some","t","rootPermission","Permission","isSelected","_children","level","child","hasUserChildPermission","childPermission","push","preparePermissionIds","result","each","_root","_child","prepareRole","_role","onSubmit","isTitleValid","editedRole","updateRole","createRole","changes","dispatch","RoleUpdated","partialrole","undefined","close","isEdit","RoleOnServerCreated","delay","selectLastCreatedRoleId","onAlertClose","$event","isSelectedChanged","permission","length","find","item","getTitle","__decorate","Component","selector","templateUrl","changeDetection","ChangeDetectionStrategy","Default","__param","Inject","MAT_DIALOG_DATA","exports"],"mappings":"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","file":"role-edit.dialog.component.min.js","sourcesContent":["import { Component, OnInit, Inject, ChangeDetectionStrategy, OnDestroy } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { Observable, of, Subscription } from 'rxjs';\r\nimport { each, find, some } from 'lodash';\r\nimport { Update } from '@ngrx/entity';\r\nimport { Store, select } from '@ngrx/store';\r\nimport { AppState } from '../../../../../core/reducers';\r\n\r\nimport {\r\n\tRole,\r\n\tPermission,\r\n\tselectRoleById,\r\n\tRoleUpdated,\r\n\tselectAllPermissions,\r\n\tselectLastCreatedRoleId,\r\n\tRoleOnServerCreated\r\n} from '../../../../../core/auth';\r\nimport { delay } from 'rxjs/operators';\r\n\r\n@Component({\r\n\tselector: 'app-role-edit-dialog',\r\n\ttemplateUrl: './role-edit.dialog.component.html',\r\n\tchangeDetection: ChangeDetectionStrategy.Default,\r\n})\r\nexport class RoleEditDialogComponent implements OnInit, OnDestroy {\r\n\r\n\trole: Role;\r\n\trole$: Observable<Role>;\r\n\thasFormErrors = false;\r\n\tviewLoading = false;\r\n\tloadingAfterSubmit = false;\r\n\tallPermissions$: Observable<Permission[]>;\r\n\trolePermissions: Permission[] = [];\r\n\r\n\tprivate componentSubscriptions: Subscription;\r\n\r\n\tconstructor(\r\n\t\tpublic dialogRef: MatDialogRef<RoleEditDialogComponent>,\r\n\t\t@Inject(MAT_DIALOG_DATA) public data: any,\r\n\t\tprivate store: Store<AppState>) {\r\n\r\n\t}\r\n\r\n\tngOnInit() {\r\n\t\tif (this.data.roleId) {\r\n\t\t\tthis.role$ = this.store.pipe(select(selectRoleById(this.data.roleId)));\r\n\t\t} else {\r\n\t\t\tconst newRole = new Role();\r\n\t\t\tnewRole.clear();\r\n\t\t\tthis.role$ = of(newRole);\r\n\t\t}\r\n\t\tthis.role$.subscribe(res => {\r\n\t\t\tif (!res) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.role = new Role();\r\n\t\t\tthis.role.id = res.id;\r\n\t\t\tthis.role.title = res.title;\r\n\t\t\tthis.role.permissions = res.permissions;\r\n\t\t\tthis.role.isCoreRole = res.isCoreRole;\r\n\r\n\t\t\tthis.allPermissions$ = this.store.pipe(select(selectAllPermissions));\r\n\t\t\tthis.loadPermissions();\r\n\t\t});\r\n\t}\r\n\r\n\tngOnDestroy() {\r\n\t\tif (this.componentSubscriptions) {\r\n\t\t\tthis.componentSubscriptions.unsubscribe();\r\n\t\t}\r\n\t}\r\n\r\n\tloadPermissions() {\r\n\t\tthis.allPermissions$.subscribe(_allPermissions => {\r\n\t\t\tif (!_allPermissions) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst mainPermissions = _allPermissions.filter(el => !el.parentId);\r\n\t\t\tmainPermissions.forEach((element: Permission) => {\r\n\t\t\t\tconst hasUserPermission = this.role.permissions.some(t => t === element.id);\r\n\t\t\t\tconst rootPermission = new Permission();\r\n\t\t\t\trootPermission.clear();\r\n\t\t\t\trootPermission.isSelected = hasUserPermission;\r\n\t\t\t\trootPermission._children = [];\r\n\t\t\t\trootPermission.id = element.id;\r\n\t\t\t\trootPermission.level = element.level;\r\n\t\t\t\trootPermission.parentId = element.parentId;\r\n\t\t\t\trootPermission.title = element.title;\r\n\t\t\t\tconst children = _allPermissions.filter(el => el.parentId && el.parentId === element.id);\r\n\t\t\t\tchildren.forEach(child => {\r\n\t\t\t\t\tconst hasUserChildPermission = this.role.permissions.some(t => t === child.id);\r\n\t\t\t\t\tconst childPermission = new Permission();\r\n\t\t\t\t\tchildPermission.clear();\r\n\t\t\t\t\tchildPermission.isSelected = hasUserChildPermission;\r\n\t\t\t\t\tchildPermission._children = [];\r\n\t\t\t\t\tchildPermission.id = child.id;\r\n\t\t\t\t\tchildPermission.level = child.level;\r\n\t\t\t\t\tchildPermission.parentId = child.parentId;\r\n\t\t\t\t\tchildPermission.title = child.title;\r\n\t\t\t\t\trootPermission._children.push(childPermission);\r\n\t\t\t\t});\r\n\t\t\t\tthis.rolePermissions.push(rootPermission);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tpreparePermissionIds(): string[] {\r\n\t\tconst result = [];\r\n\t\teach(this.rolePermissions, (_root: Permission) => {\r\n\t\t\tif (_root.isSelected) {\r\n\t\t\t\tresult.push(_root.id);\r\n\t\t\t\teach(_root._children, (_child: Permission) => {\r\n\t\t\t\t\tif (_child.isSelected) {\r\n\t\t\t\t\t\tresult.push(_child.id);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn result;\r\n\t}\r\n\r\n\tprepareRole(): Role {\r\n\t\tconst _role = new Role();\r\n\t\t_role.id = this.role.id;\r\n\t\t_role.permissions = this.preparePermissionIds();\r\n\t\t// each(this.assignedRoles, (_role: Role) => _user.roles.push(_role.id));\r\n\t\t_role.title = this.role.title;\r\n\t\t_role.isCoreRole = this.role.isCoreRole;\r\n\t\treturn _role;\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tthis.hasFormErrors = false;\r\n\t\tthis.loadingAfterSubmit = false;\r\n\t\t/** check form */\r\n\t\tif (!this.isTitleValid()) {\r\n\t\t\tthis.hasFormErrors = true;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst editedRole = this.prepareRole();\r\n\t\tif (editedRole.id) {\r\n\t\t\tthis.updateRole(editedRole);\r\n\t\t} else {\r\n\t\t\tthis.createRole(editedRole);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRole(_role: Role) {\r\n\t\tthis.loadingAfterSubmit = true;\r\n\t\tthis.viewLoading = true;\r\n\t\t/* Server loading imitation. Remove this on real code */\r\n\t\tconst updateRole: Update<Role> = {\r\n\t\t\tid: this.role.id,\r\n\t\t\tchanges: _role\r\n\t\t};\r\n\t\tthis.store.dispatch(new RoleUpdated({\r\n\t\t\tpartialrole: updateRole,\r\n\t\t\trole: _role\r\n\t\t}));\r\n\t\tof(undefined).subscribe(() => { // Remove this line\r\n\t\t\tthis.viewLoading = false;\r\n\t\t\tthis.dialogRef.close({\r\n\t\t\t\t_role,\r\n\t\t\t\tisEdit: true\r\n\t\t\t});\r\n\t\t}); // Remove this line\r\n\t}\r\n\r\n\tcreateRole(_role: Role) {\r\n\t\tthis.loadingAfterSubmit = true;\r\n\t\tthis.viewLoading = true;\r\n\t\tthis.store.dispatch(new RoleOnServerCreated({ role: _role }));\r\n\t\tthis.componentSubscriptions = this.store.pipe(\r\n\t\t\tdelay(1000), // Remove this line\r\n\t\t\tselect(selectLastCreatedRoleId)\r\n\t\t).subscribe(res => {\r\n\t\t\tif (!res) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthis.viewLoading = false;\r\n\t\t\tthis.dialogRef.close({\r\n\t\t\t\t_role,\r\n\t\t\t\tisEdit: false\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tonAlertClose($event) {\r\n\t\tthis.hasFormErrors = false;\r\n\t}\r\n\r\n\tisSelectedChanged($event, permission: Permission) {\r\n\t\tif (permission._children.length === 0 && permission.isSelected) {\r\n\t\t\tconst _root = find(this.rolePermissions, (item: Permission) => item.id === permission.parentId);\r\n\t\t\tif (_root && !_root.isSelected) {\r\n\t\t\t\t_root.isSelected = true;\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (permission._children.length === 0 && !permission.isSelected) {\r\n\t\t\tconst _root = find(this.rolePermissions, (item: Permission) => item.id === permission.parentId);\r\n\t\t\tif (_root && _root.isSelected) {\r\n\t\t\t\tif (!some(_root._children, (item: Permission) => item.isSelected === true)) {\r\n\t\t\t\t\t_root.isSelected = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (permission._children.length > 0 && permission.isSelected) {\r\n\t\t\teach(permission._children, (item: Permission) => item.isSelected = true);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (permission._children.length > 0 && !permission.isSelected) {\r\n\t\t\teach(permission._children, (item: Permission) => {\r\n\t\t\t\titem.isSelected = false;\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\tgetTitle(): string {\r\n\t\tif (this.role && this.role.id) {\r\n\t\t\treturn `Edit role '${this.role.title}'`;\r\n\t\t}\r\n\t\treturn 'New role';\r\n\t}\r\n\r\n\tisTitleValid(): boolean {\r\n\t\treturn (this.role && this.role.title && this.role.title.length > 0);\r\n\t}\r\n}\r\n"]}