"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var i=e.length-1;0<=i;i--)(n=e[i])&&(a=(s<3?n(a):3<s?n(t,o,a):n(t,o))||a);return 3<s&&a&&Object.defineProperty(t,o,a),a};exports.__esModule=!0;var core_1=require("@angular/core"),router_1=require("@angular/router"),operators_1=require("rxjs/operators"),rxjs_1=require("rxjs"),effects_1=require("@ngrx/effects"),store_1=require("@ngrx/store"),auth_actions_1=require("../_actions/auth.actions"),environment_1=require("../../../../environments/environment"),auth_selectors_1=require("../_selectors/auth.selectors"),AuthEffects=function(){function e(e,t,o,r){var n=this;this.actions$=e,this.router=t,this.auth=o,this.store=r,this.login$=this.actions$.pipe(effects_1.ofType(auth_actions_1.AuthActionTypes.Login),operators_1.tap(function(e){localStorage.setItem(environment_1.environment.authTokenKey,e.payload.authToken),n.store.dispatch(new auth_actions_1.UserRequested)})),this.logout$=this.actions$.pipe(effects_1.ofType(auth_actions_1.AuthActionTypes.Logout),operators_1.tap(function(){localStorage.removeItem(environment_1.environment.authTokenKey),n.router.navigate(["/auth/login"],{queryParams:{returnUrl:n.returnUrl}}),document.location.reload()})),this.register$=this.actions$.pipe(effects_1.ofType(auth_actions_1.AuthActionTypes.Register),operators_1.tap(function(e){localStorage.setItem(environment_1.environment.authTokenKey,e.payload.authToken)})),this.loadUser$=this.actions$.pipe(effects_1.ofType(auth_actions_1.AuthActionTypes.UserRequested),operators_1.withLatestFrom(this.store.pipe(store_1.select(auth_selectors_1.isUserLoaded))),operators_1.filter(function(e){e[0];return!e[1]}),operators_1.mergeMap(function(e){e[0],e[1];return n.auth.getUserByToken()}),operators_1.tap(function(e){e?n.store.dispatch(new auth_actions_1.UserLoaded({user:e})):n.store.dispatch(new auth_actions_1.Logout)})),this.init$=rxjs_1.defer(function(){var e=localStorage.getItem(environment_1.environment.authTokenKey),t=rxjs_1.of({type:"NO_ACTION"});return e&&(t=rxjs_1.of(new auth_actions_1.Login({authToken:e}))),t}),this.router.events.subscribe(function(e){e instanceof router_1.NavigationEnd&&(n.returnUrl=e.url)})}return __decorate([effects_1.Effect({dispatch:!1})],e.prototype,"login$"),__decorate([effects_1.Effect({dispatch:!1})],e.prototype,"logout$"),__decorate([effects_1.Effect({dispatch:!1})],e.prototype,"register$"),__decorate([effects_1.Effect({dispatch:!1})],e.prototype,"loadUser$"),__decorate([effects_1.Effect()],e.prototype,"init$"),e=__decorate([core_1.Injectable()],e)}();exports.AuthEffects=AuthEffects;
//# sourceMappingURL=auth.effects.min.js.map
